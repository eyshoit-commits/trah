name: Close PR Workflow

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to close'
        required: true
        type: number
      reason:
        description: 'Reason for closing'
        required: false
        type: string
        default: 'Closed by workflow'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  close-pr:
    name: Close Pull Request
    runs-on: ubuntu-24.04
    if: |
      (github.event_name == 'pull_request' && 
       (contains(github.event.pull_request.labels.*.name, 'wont-fix') ||
        contains(github.event.pull_request.labels.*.name, 'duplicate') ||
        contains(github.event.pull_request.labels.*.name, 'invalid') ||
        contains(github.event.pull_request.labels.*.name, 'close'))) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Comment before closing
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-number.outputs.number }};
            const reason = '${{ inputs.reason || 'Automatically closed by workflow' }}';
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîí Closing this pull request.\n\nReason: ${reason}`
            });

      - name: Close Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-number.outputs.number }};
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              state: 'closed'
            });
            
            console.log(`‚úÖ PR #${prNumber} has been closed`);

  cleanup-on-close:
    name: Cleanup after PR close
    runs-on: ubuntu-24.04
    if: github.event.action == 'closed' && github.event.pull_request.merged == false
    
    steps:
      - name: Delete branch
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            if (context.payload.pull_request.head.repo.full_name === context.repo.owner + '/' + context.repo.repo) {
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'heads/' + context.payload.pull_request.head.ref
                });
                console.log('‚úÖ Branch deleted');
              } catch (error) {
                console.log('‚ö†Ô∏è Could not delete branch:', error.message);
              }
            }

      - name: Comment cleanup complete
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üßπ Cleanup completed for closed PR.'
            })
