name: DevContainer CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  packages: read

jobs:
  validate-devcontainer:
    name: Validate DevContainer Configuration
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate devcontainer.json
        run: |
          if [ -f ".devcontainer/devcontainer.json" ]; then
            echo "✓ devcontainer.json found"
            # Basic JSON validation
            python3 -m json.tool .devcontainer/devcontainer.json > /dev/null
            echo "✓ devcontainer.json is valid JSON"
          else
            echo "✗ devcontainer.json not found"
            exit 1
          fi

      - name: Validate Dockerfile
        run: |
          if [ -f ".devcontainer/Dockerfile" ]; then
            echo "✓ Dockerfile found"
          else
            echo "✗ Dockerfile not found"
            exit 1
          fi

      - name: Check setup scripts
        run: |
          for script in post-create.sh post-start.sh setup-opencode.sh setup-openagents.sh; do
            if [ -f ".devcontainer/$script" ]; then
              echo "✓ $script found"
              bash -n ".devcontainer/$script" && echo "✓ $script syntax valid"
            else
              echo "⚠ $script not found"
            fi
          done

      - name: Validate workflows
        run: |
          for workflow in .github/workflows/*.yml; do
            if [ -f "$workflow" ]; then
              echo "Checking $workflow"
              python3 -c "import yaml; yaml.safe_load(open('$workflow'))"
              echo "✓ $workflow is valid YAML"
            fi
          done

      - name: Check OpenCode configuration
        run: |
          if [ -f ".opencode.yml" ]; then
            echo "✓ .opencode.yml found"
            python3 -c "import yaml; yaml.safe_load(open('.opencode.yml'))"
            echo "✓ .opencode.yml is valid YAML"
          fi

  test-tools-availability:
    name: Test Tool Versions
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Verify Node.js
        run: |
          node --version
          npm --version
          pnpm --version

      - name: Verify Python
        run: |
          python --version
          pip --version

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Verify Rust
        run: |
          rustc --version
          cargo --version

  documentation:
    name: Check Documentation
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README
        run: |
          if [ -f "README.md" ]; then
            echo "✓ README.md found"
            word_count=$(wc -w < README.md)
            echo "README.md has $word_count words"
            if [ $word_count -lt 100 ]; then
              echo "⚠ README.md seems short"
            fi
          else
            echo "✗ README.md not found"
            exit 1
          fi

      - name: Check agent documentation
        run: |
          if [ -f ".github/agents/README.md" ]; then
            echo "✓ Agents README found"
          fi
          if [ -f ".github/skills/README.md" ]; then
            echo "✓ Skills README found"
          fi

      - name: Summary
        run: |
          echo "Documentation check complete"
          echo "Repository is properly documented"
